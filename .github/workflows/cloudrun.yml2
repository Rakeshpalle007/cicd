name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: 'Auth Google Cloud SDK'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC/ihDSY6V8VjQT\n07UWs2baEgl2UIoYCaAc1V3EL8ugN8qRGKkqNpTMkmPiddi88FgIO7XvYdL+3fTP\nbLywDd/BW9jbf6x1Y4Pm8KS7G7iCL3FDUUAZfOxKtLsa3mYt9QFBTgOmTPyGFxf4\nYNnW8pj2uEStzFIo4TQg2IsLZiKx52mmoyEKSXR+s1eCxi8Irh3x6uRfZ66ANpwQ\nLEKIgE2ed8xjVdqAL4Avgk70/Ml9wOPJFe0Wyk8DcEeAotSyiC1nejnFPKhcgKF8\nI+hdzL75TEOSRhWVYglq1WH9W8LAoEkkNjovc1Gdk/cikRZX03boP+DcPr+2eA9r\nSOJAMGybAgMBAAECggEAEw4xTj0LoasR00ckpPWELf3NYy/wDSQoAbZYdcQrhe0H\nAhhp/AEiHJgTx9vhjCp9F5SZLQ+WZjS+vkQbIYi/0gTJNk0lYyhbXwZh3RuM56bA\npenXbrG28Fe6pZmqoLfXQB/6zPirxstVXyiDg5bvENyUOJYzNk3xWbMxYhjvKrOm\n+pcuK7nRB5pst2qgVHAN4oLkKsiN1WeP7Gd9Qz94Hv/mc1V/yNROI8a9ykEHMh1z\n7mD0mTl83JvoKMWl1y6lE4o67WdfAYazQ35a8n9uDBvSnLcZwgl1c5Ouy8FvFcrh\nr72GU5WcXRkWZuAarD2GtgYlkypEka3wVLFEaXvQgQKBgQDoYrheq7FSn4zIhGgK\ndC+8OOKsR+wFxGBOjBfQmo3S+w2TAKjmruydjbs5TxPh1i500jrGXZz/jArnUPaD\nuM2IKkBMdy6N1eac/5YSU4LMWzwf5H99TmsRIL0h8w8pL5rWLm+NHL9+oYgiOK7C\ndqH3kXor+yTqONLASmNKuHg8cwKBgQDTAMUJPo41SnDVSDWh8mXKOIfMwdwRGTrs\nTNHJxd6OzTDXkfOBO5WJa9+GD39OjzP2gnF+Rkmnzl/ZP8diYERfa73p3TL+2U2A\nKO/mVycPYGyJvls6oKyLuT7K5irg5mHRZ4PYsNwIRueSUtsK1eCnuEUYFjEWq7i0\ne5ysyBptOQKBgQCgbP5wxMCOlHzBNL8KcHk/zFmXq7MhrBb8QrRyGzBLdWtCj5MK\nZboNbnnQr2m/X3gEx9kxdhDbThd85yS3fI3PMbPf1es6mW8x9TPqBOLoJxfTwI/O\ntqMtWNeYp05RFX8j2zzBQxZj2im7zju/HdzkpvabhC5Qz9eWTgRL4huHRwKBgEY+\nyVnsg3dmUu4OXhyOECkkbMFUAKmIlr84S9c6kn9D/HCn3EM3zO61BPMikaVbs1br\n0lDRoY/F+s7elsg/eEO0IMOMqn+BZHW4KzWp6g0KctfgkYqRFyBlCWyO99Nrn0ER\njylCp93xjQJ/pwCSd3oetJHyQWFkxdcAGAbFj1axAoGAbsB1Mwd5PneJTsN8yPee\nELwyDRmbgFTrFgI0N8NfRb/wWCHdskmOeUSfcp0xSjndwiLTlg4Fqynflwa/DmJ5\nxeD93lufoAhCnqddHTTci/qToWFqvGuMn5BZ8ku0eXWsllqsuFYvy8T3WRLDAMLs\nV4J3eawOXwEMC16TnWEVA/w=\n-----END PRIVATE KEY-----\n" }}
          
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: vijaya-23
          export_default_credentials: true

      - name: 'Install gcloud beta'
        run: 'gcloud components install beta'

      - name: Authenticate Docker with gcloud
        run: |
          gcloud auth configure-docker us-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build -t us-docker.pkg.dev/vijaya-23/cloudrun/dev:latest .

      - name: Push Docker image
        run: |
          docker push us-docker.pkg.dev/vijaya-23/cloudrun/dev:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy application \
            --image us-docker.pkg.dev/vijaya-23/cloudrun/dev:latest \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --project vijaya-23
